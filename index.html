<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>rizma</title>
  <!-- Favicons -->
  <link rel="icon" href="./assets/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="./assets/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./assets/favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./assets/apple-touch-icon.png">
  <link rel="mask-icon" href="./assets/safari-pinned-tab.svg" color="#0E0E10">
  <link rel="stylesheet" href="./styles/tokens.css">
  <link rel="stylesheet" href="./styles/app.css">
</head>

<body>
  <!-- Header / Brand -->
  <header class="container">
    <div class="brand">
      <img src="./assets/rizma_logo_color.png" alt="rizma logo">
      <div class="name">rizma</div>
    </div>
    <h2 id="subtitle" class="page-subtitle">Role-Plays for The Workplace.</h2>
  </header>

  <!-- Mode Tabs -->
  <nav class="tabs container" aria-label="Mode">
    <div class="segmented" role="tablist" aria-label="Mode">
      <input type="radio" name="mode" id="modeRealtime" class="seg-radio" />
      <label id="tabRealtime" class="seg-label" for="modeRealtime" role="tab" aria-selected="true">gpt-realtime</label>

      <input type="radio" name="mode" id="modeAvatar" class="seg-radio" checked />
      <label id="tabAvatar" class="seg-label" for="modeAvatar" role="tab" aria-selected="false">CallAnnie SDK</label>
    </div>
  </nav>

  <!-- Therapist Card (Realtime default view) -->
  <section class="card">
    <img src="./assets/rizma-doc-3-elena_cropped.png" alt="Elena" class="avatar" />
    <h1 class="title">Elena</h1>
    <p class="lead">Tough Feedback. Introductions. Social.</p>
    <!-- hidden legacy button (kept for accessibility/testing) -->
    <button id="hold" aria-pressed="false" aria-label="Start Voice Session" class="mic-btn hidden">
      <svg viewBox="0 0 32 32" width="28" height="28" aria-hidden="true" focusable="false" fill="currentColor">
        <rect x="2" y="12" width="4" height="8" rx="2"></rect>
        <rect x="8" y="8" width="4" height="16" rx="2"></rect>
        <rect x="14" y="4" width="4" height="24" rx="2"></rect>
        <rect x="20" y="8" width="4" height="16" rx="2"></rect>
        <rect x="26" y="12" width="4" height="8" rx="2"></rect>
      </svg>
      <span class="sr-only">Start Voice Session</span>
    </button>
  </section>

  <!-- Role Play choices -->
  <section id="scenarios" class="container" aria-label="Role Plays">
    <div class="role-row" role="listbox" aria-label="Choose a role play">
      <button class="scenario is-selected" data-scenario="introductions" role="option" aria-selected="true">
        <div class="thumb" aria-hidden="true"></div>
        <div class="label">Introduce Yourself</div>
      </button>
      <button class="scenario" data-scenario="feedback" role="option" aria-selected="false">
        <div class="thumb" aria-hidden="true"></div>
        <div class="label">Deliver Tough Feedback</div>
      </button>
      <button class="scenario" data-scenario="happyhour" role="option" aria-selected="false">
        <div class="thumb" aria-hidden="true"></div>
        <div class="label">Social Happy Hour</div>
      </button>
    </div>
  </section>

  <audio id="remoteAudio" autoplay playsinline class="hidden"></audio>
  <!-- Fallback audio for HTTP TTS when Realtime fails -->
  <audio id="fallbackAudio" playsinline class="hidden"></audio>

  <!-- Conversation Panel (Realtime) -->
  <section id="panel" class="container hidden">
    <div class="row-end">
      <button id="endSession" class="panel-close" aria-label="End session" title="End session">
        <span aria-hidden="true" class="glyph">&times;</span>
        <span class="sr-only">End session</span>
      </button>
    </div>
    <div id="status">Idle</div>
    <div id="chat" class="chat-scroll"></div>
  </section>

  <!-- Avatar / Annie Panel (hidden until selected) -->
  <section id="avatarPanel" class="container hidden">
    <div class="card text-left">
      <div class="row-end align-center">
        <button id="endAvatar" class="panel-close hide-until-connected pos-static ml-auto z-3"
          aria-label="End avatar session" title="End avatar session">
          <span aria-hidden="true" style="font-size:20px;line-height:1">&times;</span>
          <span class="sr-only">End session</span>
        </button>
      </div>
      <div class="row mb-8" data-annie-control>
        <input id="annieToken" class="input" placeholder="Session access token" />
        <button id="annieConnect" class="btn" type="button">Connect</button>
        <button id="annieDisconnect" class="btn secondary" type="button">Disconnect</button>
      </div>
      <!-- Stage: big avatar with small self camera in the corner -->
      <h3 id="scenarioTitle" class="scenario-title hidden"></h3>
      <div id="annieStage" class="annie-stage mt-12">
        <div id="annieRoot" class="annie-root"></div>
        <video id="selfCam" class="self-cam" autoplay playsinline muted></video>
      </div>
    </div>
  </section>

  <!-- Chat composer with waveform mic (Realtime) -->
  <section id="composer" class="composer">
    <button id="composerPlus" aria-label="Add" title="Add" class="mic-btn btn-circle-36">
      +
    </button>
    <div id="composerInput" class="pill">Ask anything</div>
    <button id="micFab" class="mic-btn" aria-label="Start Voice Session" title="Start Voice Session">
      <svg viewBox="0 0 32 32" width="22" height="22" aria-hidden="true" focusable="false" fill="currentColor">
        <rect x="2" y="12" width="4" height="8" rx="2"></rect>
        <rect x="8" y="8" width="4" height="16" rx="2"></rect>
        <rect x="14" y="4" width="4" height="24" rx="2"></rect>
        <rect x="20" y="8" width="4" height="16" rx="2"></rect>
        <rect x="26" y="12" width="4" height="8" rx="2"></rect>
      </svg>
    </button>
  </section>

  <!-- Stats Page (shown after avatar session ends) -->
  <section id="statsPage" class="container hidden" aria-labelledby="statsTitle">
    <div class="card text-left">
      <h2 id="statsTitle" class="title mb-8">Session Summary</h2>
      <div class="row wrap gap-16">
        <div class="panel flex-1 min-280">
          <div class="row align-center gap-12">
            <span id="statsScore" class="big-score mr-8"></span>
            <div class="progress" style="flex:1; height:12px; background:#eee; border-radius:9999px; overflow:hidden;">
              <div id="statsProgressFill" style="height:100%; width:0%; background:linear-gradient(90deg,#22c55e,#16a34a);"></div>
            </div>
            <span id="statsPass" class="dim ml-8 hidden">—</span>
          </div>

          <h3 class="mt-12">What you did well</h3>
          <ul id="statsStrengths" class="list"></ul>

          <h3 class="mt-12">Where to improve</h3>
          <ul id="statsImprovements" class="list"></ul>
        </div>

        <div class="panel flex-1 min-280">
          <h3>Delivery</h3>
          <dl class="metrics">
            <div class="metric"><dt>WPM</dt><dd id="statsWpm">—</dd></div>
            <div class="metric"><dt>Fillers</dt><dd id="statsFillers">—</dd></div>
            <div class="metric"><dt>Pacing</dt><dd id="statsPacing">—</dd></div>
            <div class="metric"><dt>Tone</dt><dd id="statsTone">—</dd></div>
            <div class="metric"><dt>Talk time</dt><dd id="statsTalkTime">—</dd></div>
            <div class="metric"><dt>Interruptions</dt><dd id="statsInterruptions">—</dd></div>
          </dl>
        </div>
      </div>

      <div class="mt-16">
        <h3>Transcript</h3>
        <div id="statsTranscript" class="transcript mono"></div>
      </div>

      <div class="row mt-16">
        <button id="statsRetry" class="btn">Try again</button>
        <button id="statsShare" class="btn secondary ml-8">Share</button>
        <button id="statsExport" class="btn secondary ml-8">Download</button>
        <button id="statsBack" class="link-btn ml-auto">Back to home</button>
      </div>
    </div>
  </section>
  <!-- Footer -->
  <footer class="foot">
    <span>Secure &bull; Private &bull; Professional</span>
    <button id="reset" class="link-btn ml-12">Reset Session</button>
  </footer>

  <script>
    // Lightweight UI toggler for the Avatar tab (no build step needed)
    document.addEventListener('DOMContentLoaded', () => {
      const endBtn = document.getElementById('endAvatar');
      const connectBtn = document.getElementById('annieConnect');
      const disconnectBtn = document.getElementById('annieDisconnect');
      const controls = Array.from(document.querySelectorAll('#avatarPanel [data-annie-control]'));

      function setAvatarConnected(connected) {
        controls.forEach(el => el.classList.toggle('hidden', !!connected));
        if (endBtn) endBtn.style.display = connected ? 'inline-flex' : 'none';
      }

      if (connectBtn) connectBtn.addEventListener('click', () => setAvatarConnected(true));
      if (disconnectBtn) disconnectBtn.addEventListener('click', () => setAvatarConnected(false));
      if (endBtn) endBtn.addEventListener('click', () => {
        // Delegate to the existing Disconnect button so the integration cleans up
        if (disconnectBtn) disconnectBtn.click();
        setAvatarConnected(false);
        // Announce end and show the results page
        try { document.dispatchEvent(new Event('session:end')); } catch {}
        const stats = document.getElementById('statsPage');
        if (stats) stats.classList.remove('hidden');
        document.getElementById('avatarPanel')?.classList.add('hidden');
        document.getElementById('panel')?.classList.add('hidden');
        document.getElementById('composer')?.classList.add('hidden');
        document.getElementById('scenarios')?.classList.add('hidden');
      });

      // --- Role play selection (lightweight) ---
      const scenariosEl = document.getElementById('scenarios');
      const scenarioBtns = Array.from(document.querySelectorAll('#scenarios .scenario'));
      function setScenario(s) {
        window.selectedScenario = s; // expose for main.ts if needed
        scenarioBtns.forEach(btn => {
          const on = btn.dataset.scenario === s;
          btn.classList.toggle('is-selected', on);
          btn.setAttribute('aria-selected', String(on));
        });
        document.dispatchEvent(new CustomEvent('scenario:selected', { detail: { scenario: s } }));
      }
      if (scenarioBtns.length) {
        // default
        setScenario('introductions');
        scenarioBtns.forEach(btn => btn.addEventListener('click', () => setScenario(btn.dataset.scenario)));
      }
      // Optional hooks to hide/show choices when a session starts/ends.
      document.addEventListener('session:start', () => { if (scenariosEl) scenariosEl.classList.add('hidden'); });
      document.addEventListener('session:end', () => { if (scenariosEl) scenariosEl.classList.remove('hidden'); });

      // --- Scenario title handling ---
      const scenarioTitleEl = document.getElementById('scenarioTitle');
      function setScenarioTitleFromSelection() {
        try {
          const sel = document.querySelector('#scenarios .scenario.is-selected .label');
          if (sel && scenarioTitleEl) scenarioTitleEl.textContent = sel.textContent || '';
        } catch { }
      }
      function showScenarioTitle(show) {
        if (!scenarioTitleEl) return;
        scenarioTitleEl.classList.toggle('hidden', !show);
      }
      // keep title text in sync with selection (hidden until session starts)
      document.addEventListener('scenario:selected', setScenarioTitleFromSelection);
      setScenarioTitleFromSelection();

      // Show title when user starts avatar via waveform button
      const micFabBtn = document.getElementById('micFab');
      const modeAvatar = document.getElementById('modeAvatar');
      if (micFabBtn) {
        micFabBtn.addEventListener('click', () => {
          if (modeAvatar && modeAvatar.checked) {
            setScenarioTitleFromSelection();
            showScenarioTitle(true);
            if (scenariosEl) scenariosEl.classList.add('hidden');
            document.dispatchEvent(new Event('session:start'));
          }
        });
      }
      // Also show on explicit Avatar Connect button
      if (connectBtn) connectBtn.addEventListener('click', () => { setScenarioTitleFromSelection(); showScenarioTitle(true); });
      // Hide on end/disconnect and on global session end
      if (disconnectBtn) disconnectBtn.addEventListener('click', () => showScenarioTitle(false));
      if (endBtn) endBtn.addEventListener('click', () => showScenarioTitle(false));
      document.addEventListener('session:end', () => showScenarioTitle(false));

      // --- Stats progress sync ---
      (function initStatsProgress() {
        const scoreEl = document.getElementById('statsScore');
        const fillEl = document.getElementById('statsProgressFill');
        const passEl = document.getElementById('statsPass');
        const titleEl = document.getElementById('statsTitle');
        if (!scoreEl || !fillEl) return;
        function apply(val) {
          const v = Math.max(0, Math.min(100, Number(val) || 0));
          fillEl.style.width = v + '%';
          // color hints by thresholds
          let color = '#22c55e'; // green
          if (v < 60) color = '#ef4444'; // red
          else if (v < 75) color = '#f59e0b'; // amber
          fillEl.style.background = `linear-gradient(90deg, ${color}, ${color})`;
          const sel = document.querySelector('#scenarios .scenario.is-selected .label');
          const rp = (sel && sel.textContent ? sel.textContent : 'Role-Play').trim();
          const res = v >= 70 ? 'PASS' : 'NEEDS WORK';
          if (titleEl) titleEl.textContent = `${rp}: ${res}`;
          if (passEl) passEl.textContent = '';
        }
        // 1) apply initial
        apply(scoreEl.textContent);
        // 2) keep in sync if main.ts updates the text later
        const mo = new MutationObserver(() => apply(scoreEl.textContent));
        mo.observe(scoreEl, { childList: true, characterData: true, subtree: true });
        // also respond when the results page is shown
        document.addEventListener('session:end', () => apply(scoreEl.textContent));
      })();
      // --- Mock Delivery metrics for the summary page ---
      function fillMockMetrics() {
        const set = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.textContent = val;
        };
        set('statsWpm', '138');              // words per minute
        set('statsFillers', '3 (um/uh)');    // filler count
        set('statsPacing', 'Even');
        set('statsTone', 'Calm/neutral');
        set('statsTalkTime', '62%');
        set('statsInterruptions', '1');
      }
      // Populate when a session ends (and if the page is opened directly)
      document.addEventListener('session:end', fillMockMetrics);
      fillMockMetrics();
    });
  </script>
  <script type="module" src="/src/main.ts"></script>
</body>

</html>